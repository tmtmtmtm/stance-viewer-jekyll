#!/usr/bin/ruby

# Generate pages for each Person

require 'json'
require 'yaml'
require 'parallel'

@people  = JSON.parse(File.read('_data/people.yaml'))
@parties = JSON.parse(File.read('_data/parties.yaml'))

def dates(membership)
  return "" unless membership['start_date'] || membership['end_date']
  return [membership['start_date'], membership['end_date']].map {|s| s && s[0,4] }.join " â€“ ".strip
end

def memberships(mp)
  mp['memberships'].map { |m|
    party = @parties.detect { |p| p['id'] == m['organization_id'] } || next
    {
      "id" => m['organization_id'],
      "name" => party['name'],
      "start" => m['start_date'],
      "end" => m['end_date'],
    }
  }.reject(&:nil?)
end

ppl = ARGV[0].nil? ? @people : @people.select { |mp| mp['id'] == ARGV[0] }
warn "Generating #{ppl.count} pages"

Parallel.each(ppl, :in_threads => 10) do |mp|
  filename = "person/#{mp['id']}.md"
  data = {
    "layout" => 'mp',
    "id" => mp['id'],
    "name" => mp['name'],
    "memberships" => memberships(mp),
    "autogenerated" => true,
  }
  text = data.to_yaml + "---\n"
  File.write(filename, text)
end
